<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Fornecedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="imagens/favicon.ico" type="image/x-icon">
    <style>
        /* Estilos personalizados */
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
            --background-color: #f3f4f6;
            --sidebar-bg: #1f2937;
            --sidebar-text: #d1d5db;
            --sidebar-hover: #374151;
            --table-header: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
        }

        /* Animação de transição para a sidebar */
        #sidebar {
            transition: width 0.3s ease-in-out;
        }

        .sidebar-item-text {
            transition: opacity 0.3s ease-in-out;
        }

        /* Corrige o problema de clique na barra lateral fechada */
        #sidebar.w-20 .sidebar-item-text {
            pointer-events: none;
        }

        /* Estilos para o Toast/Notificação */
        #toast {
            transition: opacity 0.5s, transform 0.5s;
        }

        /* Animação de entrada do Modal */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal {
            transition: opacity 0.3s ease-out;
        }

        .modal>div>div {
            /* Target the inner div for transform animation */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal[aria-hidden="false"] {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .modal[aria-hidden="false"]>div {
            animation: slideIn 0.4s ease-out forwards;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
        }

        .copy-btn:hover {
            color: var(--primary-color);
        }

        .address-list-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .address-list-item:hover {
            background-color: #f9fafb;
        }

        /* Estilos do Loader de Importação e Carregamento */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .dot-loader {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: dot-loader-animation 1.4s infinite ease-in-out both;
            display: inline-block;
        }

        .dot-loader.dot-1 {
            animation-delay: -0.32s;
        }

        .dot-loader.dot-2 {
            animation-delay: -0.16s;
        }

        @keyframes dot-loader-animation {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        /* Estilos para Células Copiáveis */
        .copyable-cell {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .copyable-cell:hover {
            background-color: #eef2ff;
            /* indigo-100 */
        }

        /* Animação para o ícone de importação */
        .pulsing-cloud {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
        }

        /* Estilos para Tabela Rolável */
        #main-view .table-container {
            flex-grow: 1;
            overflow-y: auto;
        }

        #main-view thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Estilos para o dropdown de filtro */
        #filter-column-dropdown ul {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="initial-loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[100]">
        <div class="loader-container">
            <div class="flex space-x-2">
                <div class="dot-loader dot-1"></div>
                <div class="dot-loader dot-2"></div>
                <div class="dot-loader dot-3"></div>
            </div>
            <p class="text-gray-600 mt-4">Carregando sistema...</p>
        </div>
    </div>

    <div id="login-view" class="hidden flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 sm:p-12 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center">
                <h1 id="login-title" class="text-3xl font-bold text-gray-800" style="color: #3b82f6;">Gestão de
                    Fornecedores</h1>
                <p id="login-subtitle" class="mt-2 text-gray-500">Acesse seu painel de controle</p>
            </div>

            <form id="auth-form" class="mt-10 space-y-6">
                <div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <ion-icon name="mail-outline" class="text-gray-400"></ion-icon>
                        </span>
                        <input type="email" id="email-input" placeholder="Seu e-mail"
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>
                </div>

                <div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <ion-icon name="lock-closed-outline" class="text-gray-400"></ion-icon>
                        </span>
                        <input type="password" id="password-input" placeholder="Sua senha"
                            class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                        <button type="button" id="password-toggle"
                            class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
                            title="Mostrar/Ocultar senha">
                            <ion-icon name="eye-outline" id="password-toggle-icon"></ion-icon>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Lembrar de mim</label>
                    </div>
                    <div class="text-sm">
                        <a href="#" class="font-medium text-blue-600 hover:text-blue-500">Esqueceu a senha?</a>
                    </div>
                </div>

                <div>
                    <button type="submit" id="auth-button"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden h-screen w-screen flex">
        <aside id="sidebar" class="bg-gray-800 text-gray-300 w-20 flex flex-col space-y-2 p-2 z-20"
            style="background-color: var(--sidebar-bg);">
            <div class="flex items-center p-2 h-16">
                <div id="logo-container" class="flex items-center overflow-hidden">
                    <span id="logo-text"
                        class="font-bold text-xl whitespace-nowrap opacity-0 transition-opacity duration-300 pl-3 text-indigo-400">SGF</span>
                </div>
                <button id="toggleSidebar" class="p-2 rounded-md hover:bg-gray-700 ml-auto" title="Abrir/Fechar Menu">
                    <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
                </button>
            </div>

            <nav class="flex-1 space-y-2">
                <a href="#" id="show-main-view" class="flex items-center p-3 rounded-lg bg-indigo-600 text-white"
                    style="--hover-color: var(--sidebar-hover);" title="Fornecedores">
                    <ion-icon name="people-outline" class="text-2xl min-w-[40px]"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Fornecedores</span>
                </a>
                <a href="#" id="show-cep-view" class="flex items-center p-3 rounded-lg hover:bg-gray-700"
                    style="--hover-color: var(--sidebar-hover);" title="Buscar CEP (CTRL+S) / Endereço (CTRL+A)">
                    <ion-icon name="map-outline" class="text-2xl min-w-[40px]"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Buscar Endereço</span>
                </a>
                <a href="#" id="show-cnpj-view" class="flex items-center p-3 rounded-lg hover:bg-gray-700"
                    style="--hover-color: var(--sidebar-hover);" title="Buscar CNPJ (CTRL+D)">
                    <ion-icon name="business-outline" class="text-2xl min-w-[40px]"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Buscar CNPJ</span>
                </a>
                <a href="#" id="show-settings-view" class="flex items-center p-3 rounded-lg hover:bg-gray-700"
                    style="--hover-color: var(--sidebar-hover);" title="Configurações">
                    <ion-icon name="settings-outline" class="text-2xl min-w-[40px]"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Configurações</span>
                </a>
                <a href="#" id="background-import-status" title="Importação em andamento..."
                    class="hidden items-center p-3 rounded-lg hover:bg-gray-700"
                    style="--hover-color: var(--sidebar-hover);">
                    <ion-icon name="cloud-upload-outline"
                        class="text-2xl min-w-[40px] text-indigo-400 pulsing-cloud"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Importando...</span>
                </a>
            </nav>

            <div class="p-2 border-t border-gray-700">
                <a href="#" id="logout-button" class="flex items-center p-3 rounded-lg hover:bg-gray-700"
                    style="--hover-color: var(--sidebar-hover);" title="Sair do Sistema">
                    <ion-icon name="log-out-outline" class="text-2xl min-w-[40px]"></ion-icon>
                    <span class="sidebar-item-text ml-4 font-medium whitespace-nowrap opacity-0">Sair</span>
                </a>
            </div>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm p-4 h-16 flex items-center justify-between z-10">
                <h1 id="header-title" class="text-2xl font-bold text-gray-800">Gerenciamento de Fornecedores</h1>
                <div class="flex items-center space-x-4">
                    <div id="header-search-container" class="w-full max-w-xs hidden">
                        <button id="new-cnpj-search-btn"
                            class="w-full bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700 flex items-center justify-center space-x-2"
                            title="Realizar uma nova busca de CNPJ (CTRL+D)">
                            <ion-icon name="search-outline"></ion-icon>
                            <span>Nova Busca (CTRL+D)</span>
                        </button>
                    </div>
                    <div id="header-bulk-delete-container" class="hidden">
                        <button id="bulk-delete-btn-header"
                            class="bg-red-500 text-white px-4 py-2 text-sm rounded-md hover:bg-red-600 flex items-center space-x-2"
                            title="Excluir fornecedores selecionados">
                            <ion-icon name="trash-outline"></ion-icon>
                            <span>Excluir</span>
                        </button>
                    </div>
                </div>
            </header>

            <main id="main-view" class="flex-1 p-6 overflow-y-auto">
                <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-4">
                            <h2 class="text-xl font-semibold text-gray-700">Lista de Fornecedores</h2>
                            <button id="open-export-modal-btn"
                                class="bg-blue-500 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-600 flex items-center space-x-2"
                                title="Exportar dados">
                                <ion-icon name="download-outline"></ion-icon>
                                <span>Exportar</span>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-600">Coluna filtrada:</span>
                            <!-- Dropdown de Filtro de Coluna -->
                            <div id="filter-column-dropdown" class="relative">
                                <button id="filter-column-btn"
                                    class="flex items-center space-x-2 bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <span id="filter-column-text">Todas as Colunas</span>
                                    <ion-icon name="chevron-down-outline" class="text-gray-500"></ion-icon>
                                </button>
                                <ul id="filter-column-list"
                                    class="absolute right-0 mt-2 w-48 bg-white border rounded-md shadow-lg z-20 hidden origin-top-right transform opacity-0 scale-95">
                                    <li data-value="all"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Todas
                                        as Colunas</li>
                                    <li data-value="code"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Cód.
                                    </li>
                                    <li data-value="cnpj"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">CNPJ
                                    </li>
                                    <li data-value="name"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Nome
                                    </li>
                                    <li data-value="clientCode"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Cód.
                                        Cliente</li>
                                    <li data-value="observations"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                        Observações</li>
                                </ul>
                            </div>
                            <button id="clear-filter-btn"
                                class="p-2 text-gray-500 hover:text-gray-800 rounded-full"
                                title="Limpar filtro">
                                <svg class="w-6 h-6 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 64 64"
                                    xmlns="http://www.w3.org/2000/svg">

                                    <!-- Cabo da vassoura -->
                                    <line x1="32" y1="4" x2="32" y2="32" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" />

                                    <!-- Base de madeira -->
                                    <rect x="26" y="30" width="12" height="6" rx="2" ry="2" fill="currentColor" />

                                    <!-- Corpo da vassoura -->
                                    <path d="M16 36h32l4 18c1 5-3 6-8 6H20c-5 0-9-1-8-6l4-18z" stroke="currentColor"
                                        stroke-width="3" stroke-linejoin="round" fill="none" />

                                    <!-- Cerdas -->
                                    <line x1="20" y1="60" x2="20" y2="50" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" />
                                    <line x1="28" y1="60" x2="28" y2="50" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" />
                                    <line x1="36" y1="60" x2="36" y2="50" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" />
                                    <line x1="44" y1="60" x2="44" y2="50" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" />
                                </svg>
                            </button>

                            <!-- Input de Busca -->
                            <div class="relative">
                                <input type="text" id="supplier-search-input" placeholder="Buscar... (CTRL+F)"
                                    class="w-[36rem] pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <ion-icon name="search-outline"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100" style="background-color: var(--table-header);">
                                <tr>
                                    <th class="py-1 px-4 w-12"><input type="checkbox" id="select-all-checkbox"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                            title="Selecionar Todos">
                                    </th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer whitespace-nowrap"
                                        data-sort-key="code">
                                        <div class="flex items-center">Cód.<ion-icon name="caret-down-outline"
                                                class="ml-1 opacity-50"></ion-icon></div>
                                    </th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600">CNPJ</th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                                        data-sort-key="name">
                                        <div class="flex items-center">Nome do Fornecedor<ion-icon
                                                name="caret-down-outline" class="ml-1 opacity-50"></ion-icon></div>
                                    </th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600">Cód. Cliente
                                    </th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600">Observações</th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600">Ações</th>
                                    <th class="py-1 px-4 text-left text-sm font-semibold text-gray-600">Info</th>
                                </tr>
                            </thead>
                            <tbody id="supplier-table-body" class="text-gray-700">
                                <!-- O conteúdo será preenchido pelo JavaScript, começando com um loader -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-controls"
                        class="flex flex-wrap justify-center items-center gap-4 mt-auto pt-4 border-t"></div>
                </div>
            </main>

            <div id="cep-search-view" class="flex-1 p-6 overflow-y-auto hidden">
                <div id="cep-search-container" class="bg-white p-8 rounded-xl shadow-sm mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Buscar Endereço</h2>
                    <p class="text-gray-500">Busque por CEP (CTRL+S) ou pelo endereço (CTRL+A).</p>

                    <div class="border-b border-gray-200 mt-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-by-cep"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                                Por CEP
                            </button>
                            <button id="tab-by-address"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Por Endereço
                            </button>
                        </nav>
                    </div>

                    <form id="cep-form" class="mt-6">
                        <label for="cepInput" class="block text-sm font-medium text-gray-700">Digite o CEP</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="text" id="cepInput" placeholder="00000-000" maxlength="9"
                                class="flex-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                required>
                            <button type="submit"
                                class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 flex items-center space-x-2">
                                <ion-icon name="search-outline"></ion-icon>
                                <span>Buscar</span>
                            </button>
                        </div>
                    </form>

                    <form id="address-form" class="hidden mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-[1fr_2fr_3fr_auto] gap-4 items-end">
                            <div>
                                <label for="ufInput" class="block text-sm font-medium text-gray-700">UF</label>
                                <input type="text" id="ufInput" placeholder="SP" maxlength="2"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                            </div>
                            <div>
                                <label for="cityInput" class="block text-sm font-medium text-gray-700">Cidade</label>
                                <input type="text" id="cityInput" placeholder="São Paulo"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                            </div>
                            <div>
                                <label for="streetInput"
                                    class="block text-sm font-medium text-gray-700">Logradouro</label>
                                <input type="text" id="streetInput" placeholder="Av. Paulista"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                            </div>
                            <div>
                                <button type="submit"
                                    class="bg-indigo-600 text-white px-5 py-2 h-10 rounded-md hover:bg-indigo-700 flex items-center justify-center space-x-2 w-full">
                                    <ion-icon name="search-outline"></ion-icon>
                                    <span>Buscar</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="cep-result">
                    <div class="flex items-center justify-center text-gray-500">
                        <p>Aguardando busca...</p>
                    </div>
                </div>
            </div>

            <div id="cnpj-search-view" class="flex-1 p-6 overflow-y-auto hidden">
                <div id="cnpj-search-container" class="bg-white p-8 rounded-xl shadow-sm mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Consultar CNPJ</h2>
                    <p class="text-gray-500">Busque por um CNPJ para ver os detalhes da empresa. (CTRL+D)</p>
                    <form id="cnpj-search-form" class="mt-6">
                        <label for="view-cnpj-input" class="block text-sm font-medium text-gray-700">Digite o
                            CNPJ</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="text" id="view-cnpj-input" placeholder="00.000.000/0000-00"
                                class="flex-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                required maxlength="18">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 flex items-center space-x-2">
                                <ion-icon name="search-outline"></ion-icon>
                                <span>Buscar</span>
                            </button>
                        </div>
                    </form>
                </div>
                <div id="cnpj-result" class="h-full">
                    <!-- O conteúdo da busca será inserido aqui -->
                </div>
            </div>


            <div id="settings-view" class="flex-1 p-6 overflow-y-auto hidden">
                <div class="bg-white p-8 rounded-xl shadow-sm max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Configurações da Conta</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">E-mail</p>
                            <p id="user-email" class="text-lg text-gray-800"></p>
                        </div>
                        <div>
                            <button id="reset-password-btn"
                                class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 flex items-center space-x-2">
                                <ion-icon name="key-outline"></ion-icon>
                                <span>Redefinir Senha</span>
                            </button>
                            <p class="text-xs text-gray-500 mt-2">Um e-mail será enviado para você com as instruções
                                para criar uma nova senha.</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Preferências da Tabela</h3>
                        <div class="mb-6">
                            <p class="text-sm font-medium text-gray-600">Comportamento do "Selecionar Tudo"</p>
                            <p class="text-xs text-gray-500 mb-2">Escolha o que acontece ao marcar a caixa de seleção
                                principal na tabela de fornecedores.</p>
                            <fieldset class="mt-2">
                                <legend class="sr-only">Opções de seleção</legend>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input id="select-mode-page" name="select-mode" type="radio" value="page"
                                            class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                        <label for="select-mode-page" class="ml-3 block text-sm text-gray-700">
                                            Selecionar apenas os itens da página atual
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="select-mode-all" name="select-mode" type="radio" value="all"
                                            class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                        <label for="select-mode-all" class="ml-3 block text-sm text-gray-700">
                                            Selecionar todos os itens (em todas as páginas)
                                        </label>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="rows-per-page-select" class="text-sm font-medium text-gray-600">Linhas por
                                página</label>
                            <select id="rows-per-page-select"
                                class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="add-supplier-btn"
        class="fixed bottom-8 right-8 bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-110 z-30"
        style="background-color: var(--primary-color);" title="Adicionar Fornecedor (CTRL+G)">
        <ion-icon name="add-outline" class="text-3xl"></ion-icon>
    </button>

    <div id="supplierModal" aria-hidden="true"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Cadastrar Novo Fornecedor</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>

            <div id="modal-content">
                <form id="supplier-form" class="space-y-4">
                    <input type="hidden" id="editSupplierId" name="editSupplierId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="supplierCode" class="block text-sm font-medium text-gray-700">Cód. Fornecedor
                                <span class="text-red-500">*</span></label>
                            <input type="text" id="supplierCode" name="supplierCode"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                required>
                        </div>
                        <div>
                            <label for="supplierCnpj" class="block text-sm font-medium text-gray-700">CNPJ <span
                                    class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" id="supplierCnpj" name="supplierCnpj"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    maxlength="18" required>
                                <div id="cnpj-loader" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                                    <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg"
                                        fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="supplierName" class="block text-sm font-medium text-gray-700">Nome do Fornecedor
                            <span class="text-red-500">*</span></label>
                        <input type="text" id="supplierName" name="supplierName"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-gray-100"
                            required readonly>
                    </div>

                    <div>
                        <label for="clientCode" class="block text-sm font-medium text-gray-700">Cód. Cliente</label>
                        <input type="text" id="clientCode" name="clientCode"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="observations" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="observations" name="observations" rows="3"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>

                    <div class="flex justify-end pt-4 space-x-3 border-t">
                        <label for="json-file-input"
                            class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition cursor-pointer flex items-center gap-2"
                            title="Importar fornecedores de um arquivo JSON">
                            <ion-icon name="cloud-upload-outline"></ion-icon> Importar JSON
                        </label>
                        <input type="file" id="json-file-input" class="hidden" accept=".json">

                        <button type="button" id="cancelBtn"
                            class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition"
                            style="background-color: var(--primary-color);">Salvar Fornecedor</button>
                    </div>
                </form>
            </div>
            <div id="import-loader" class="hidden">
                <div class="loader-container">
                    <div class="flex space-x-2">
                        <div class="dot-loader dot-1"></div>
                        <div class="dot-loader dot-2"></div>
                        <div class="dot-loader dot-3"></div>
                    </div>
                    <p class="text-gray-600 mt-4">Importando fornecedores...</p>
                    <p id="import-progress" class="text-sm text-indigo-600 font-medium"></p>
                    <div class="mt-4 flex space-x-2">
                        <button id="cancel-import-btn"
                            class="bg-red-500 text-white px-4 py-2 text-sm rounded-md hover:bg-red-600">Cancelar</button>
                        <button id="run-in-background-btn"
                            class="bg-gray-500 text-white px-4 py-2 text-sm rounded-md hover:bg-gray-600">Rodar em 2º
                            Plano</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform translate-y-[-20px] z-[60]">
        <p id="toast-message">Mensagem de erro!</p>
    </div>

    <div id="confirmDeleteModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800">Confirmar Exclusão</h3>
            <p id="confirmMessage" class="mt-2 text-sm text-gray-600">Você tem certeza que deseja excluir os itens
                selecionados?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelDeleteBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirmDeleteBtn"
                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Excluir</button>
            </div>
        </div>
    </div>

    <div id="confirmDuplicateModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-yellow-600">Fornecedor Duplicado</h3>
            <p id="duplicateMessage" class="mt-2 text-sm text-gray-600">Já existe um fornecedor com este Código ou CNPJ.
                Deseja cadastrar mesmo assim?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelDuplicateBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Não</button>
                <button id="confirmDuplicateBtn"
                    class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition">Sim,
                    Cadastrar</button>
            </div>
        </div>
    </div>

    <div id="exportModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Opções de Exportação</h3>
            <form id="export-form" class="mt-4 space-y-6">
                <div>
                    <p class="text-sm font-medium text-gray-700">Exportar</p>
                    <fieldset class="mt-2">
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="export-scope-all" name="export-scope" type="radio" value="all"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                                <label for="export-scope-all" class="ml-3 block text-sm text-gray-700">Tudo</label>
                            </div>
                            <div class="flex items-center">
                                <input id="export-scope-selected" name="export-scope" type="radio" value="selected"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="export-scope-selected" class="ml-3 block text-sm text-gray-700">Itens
                                    Selecionados</label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700">Tipo de arquivo</p>
                    <fieldset class="mt-2">
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="export-type-json" name="export-type" type="radio" value="json"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                                <label for="export-type-json" class="ml-3 block text-sm text-gray-700">JSON</label>
                            </div>
                            <div class="flex items-center">
                                <input id="export-type-excel" name="export-type" type="radio" value="excel"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="export-type-excel" class="ml-3 block text-sm text-gray-700">Excel
                                    (XLSX)</label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelExportBtn"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Exportar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importPreviewModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-800">Análise de Importação</h3>
            <div class="mt-4 space-y-2 text-sm">
                <p>Fornecedores encontrados no arquivo: <span id="preview-total" class="font-bold"></span></p>
                <p>Fornecedores duplicados (serão ignorados): <span id="preview-duplicates"
                        class="font-bold text-red-600"></span></p>
                <p>Fornecedores válidos para importar: <span id="preview-valid" class="font-bold text-green-600"></span>
                </p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelImportPreviewBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirmImportBtn"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Importar</button>
            </div>
        </div>
    </div>


    <div id="importReportModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Relatório de Importação</h3>
                <button id="closeImportReportBtn" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div id="importReportContent" class="mt-2 text-sm text-gray-600 max-h-80 overflow-y-auto">
            </div>
            <div class="mt-6 flex justify-end">
                <button id="okImportReportBtn"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal de Informações do Fornecedor -->
    <div id="infoModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800">Detalhes do Fornecedor</h3>
                <button id="closeInfoModalBtn" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div id="infoModalContent" class="mt-4 space-y-3 text-sm">
                <!-- Conteúdo injetado via JS -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="okInfoModalBtn"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // UPDATED: Using a newer version of Firebase SDK (v10.12.2)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB5tdaJvlB1UkFemO6X_D19rbzZgiR3b0Q",
            authDomain: "cgf-web.firebaseapp.com",
            projectId: "cgf-web",
            storageBucket: "cgf-web.firebasestorage.app",
            messagingSenderId: "546201159693",
            appId: "1:546201159693:web:973e7c33aa165543b76d44"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Colocar toda a lógica da aplicação dentro do DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Proxy para contornar problemas de CORS (usando um novo proxy) ---
            const corsProxy = 'https://api.codetabs.com/v1/proxy/?quest=';

            // --- Função de Notificação (Toast) ---
            const showToast = (message, type = 'error') => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('bg-red-500', 'bg-green-500', 'bg-blue-500');
                if (type === 'success') toast.classList.add('bg-green-500');
                else if (type === 'info') toast.classList.add('bg-blue-500');
                else toast.classList.add('bg-red-500');
                toast.classList.remove('opacity-0', 'translate-y-[-20px]');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 4000);
            };
            window.showToast = showToast;

            // --- Lógica de Autenticação ---
            const initialLoader = document.getElementById('initial-loader');
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const passwordToggle = document.getElementById('password-toggle');
            const passwordToggleIcon = document.getElementById('password-toggle-icon');
            const authButton = document.getElementById('auth-button');
            const logoutButton = document.getElementById('logout-button');
            let unsubscribeSuppliers = null;

            onAuthStateChanged(auth, user => {
                initialLoader.classList.add('hidden');
                if (user) {
                    loginView.classList.remove('flex');
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    addSupplierBtn.style.display = 'flex'; // Mostra o botão ao logar (padrão é a main view)
                    setupRealtimeListener();
                } else {
                    appView.classList.add('hidden');
                    addSupplierBtn.style.display = 'none'; // Esconde o botão na tela de login
                    loginView.classList.remove('hidden');
                    loginView.classList.add('flex');
                    if (unsubscribeSuppliers) {
                        unsubscribeSuppliers();
                    }
                    suppliers = [];
                    renderTable();
                }
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                authButton.disabled = true;
                authButton.textContent = 'Entrando...';

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    let msg = 'Ocorreu um erro ao tentar fazer login.';
                    if (error.code === 'auth/invalid-credential') {
                        msg = 'E-mail ou senha inválidos.';
                    }
                    showToast(msg, 'error');
                } finally {
                    authButton.disabled = false;
                    authButton.textContent = 'Entrar';
                }
            });

            logoutButton.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                } catch (error) {
                    showToast('Erro ao tentar sair.', 'error');
                }
            });

            passwordToggle.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                passwordToggleIcon.name = isPassword ? 'eye-off-outline' : 'eye-outline';
            });

            // --- O restante do código da aplicação ---
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            const logoText = document.getElementById('logo-text');
            const sidebarItemsText = document.querySelectorAll('.sidebar-item-text');

            const addSupplierBtn = document.getElementById('add-supplier-btn');
            const supplierModal = document.getElementById('supplierModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const supplierForm = document.getElementById('supplier-form');
            const supplierTableBody = document.getElementById('supplier-table-body');
            const tableHead = document.querySelector('#main-view thead');

            const modalTitle = document.getElementById('modal-title');
            const editSupplierIdInput = document.getElementById('editSupplierId');

            const cnpjInput = document.getElementById('supplierCnpj');
            const nameInput = document.getElementById('supplierName');
            const cnpjLoader = document.getElementById('cnpj-loader');

            const bulkDeleteBtnHeader = document.getElementById('bulk-delete-btn-header');
            const headerBulkDeleteContainer = document.getElementById('header-bulk-delete-container');

            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const paginationControls = document.getElementById('pagination-controls');
            const supplierSearchInput = document.getElementById('supplier-search-input');

            // Views
            const mainView = document.getElementById('main-view');
            const cepSearchView = document.getElementById('cep-search-view');
            const cnpjSearchView = document.getElementById('cnpj-search-view');
            const settingsView = document.getElementById('settings-view');
            const headerTitle = document.getElementById('header-title');

            // Botões de navegação da View
            const showMainViewBtn = document.getElementById('show-main-view');
            const showCepViewBtn = document.getElementById('show-cep-view');
            const showCnpjViewBtn = document.getElementById('show-cnpj-view');
            const showSettingsViewBtn = document.getElementById('show-settings-view');

            // Novos elementos de filtro
            const filterColumnBtn = document.getElementById('filter-column-btn');
            const filterColumnList = document.getElementById('filter-column-list');
            const filterColumnText = document.getElementById('filter-column-text');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            // Busca CEP
            const cepForm = document.getElementById('cep-form');
            const cepInput = document.getElementById('cepInput');
            const addressForm = document.getElementById('address-form');
            const ufInput = document.getElementById('ufInput');
            const cityInput = document.getElementById('cityInput');
            const streetInput = document.getElementById('streetInput');
            const cepResultDiv = document.getElementById('cep-result');
            const tabByCep = document.getElementById('tab-by-cep');
            const tabByAddress = document.getElementById('tab-by-address');

            // Busca CNPJ
            const cnpjSearchContainer = document.getElementById('cnpj-search-container');
            const headerSearchContainer = document.getElementById('header-search-container');
            const newCnpjSearchBtn = document.getElementById('new-cnpj-search-btn');
            const cnpjResultDiv = document.getElementById('cnpj-result');
            const cnpjSearchForm = document.getElementById('cnpj-search-form');
            const viewCnpjInput = document.getElementById('view-cnpj-input');


            // Modal de Confirmação Exclusão
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const confirmMessage = document.getElementById('confirmMessage');
            let deleteConfirmCallback = null;

            // Export Modal
            const exportModal = document.getElementById('exportModal');
            const openExportModalBtn = document.getElementById('open-export-modal-btn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const exportForm = document.getElementById('export-form');

            // Modal de Confirmação Duplicidade
            const confirmDuplicateModal = document.getElementById('confirmDuplicateModal');
            const cancelDuplicateBtn = document.getElementById('cancelDuplicateBtn');
            const confirmDuplicateBtn = document.getElementById('confirmDuplicateBtn');
            let duplicateConfirmCallback = null;

            // Modal de Relatório de Importação
            const importReportModal = document.getElementById('importReportModal');
            const closeImportReportBtn = document.getElementById('closeImportReportBtn');
            const okImportReportBtn = document.getElementById('okImportReportBtn');
            const importReportContent = document.getElementById('importReportContent');

            // Modal de Preview de Importação
            const importPreviewModal = document.getElementById('importPreviewModal');
            const cancelImportPreviewBtn = document.getElementById('cancelImportPreviewBtn');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            let importDataCache = null;

            // NOVO: Modal de Informações
            const infoModal = document.getElementById('infoModal');
            const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
            const okInfoModalBtn = document.getElementById('okInfoModalBtn');
            const infoModalContent = document.getElementById('infoModalContent');

            // Configurações
            const userEmailEl = document.getElementById('user-email');
            const resetPasswordBtn = document.getElementById('reset-password-btn');
            const selectModePageRadio = document.getElementById('select-mode-page');
            const selectModeAllRadio = document.getElementById('select-mode-all');
            const rowsPerPageSelect = document.getElementById('rows-per-page-select');


            let suppliers = [];
            let currentPage = 1;
            let ROWS_PER_PAGE = 50;
            const selectedSuppliers = new Set();
            let cnpjSearchPerformed = false;
            let searchFilter = '';
            let searchDebounceTimer;
            let isImportCancelled = false;
            let isImportingInBackground = false;
            let sortConfig = { key: 'dateTime', direction: 'desc' };
            let selectAllMode = 'page';
            let searchColumn = 'all';

            // --- Lógica do Firestore ---
            function setupRealtimeListener() {
                if (unsubscribeSuppliers) unsubscribeSuppliers();

                const suppliersCollectionRef = collection(db, 'suppliers_public');
                const q = query(suppliersCollectionRef);

                unsubscribeSuppliers = onSnapshot(q, (snapshot) => {
                    suppliers = [];
                    snapshot.forEach(doc => {
                        suppliers.push({ ...doc.data(), id: doc.id });
                    });
                    renderTable();
                }, (error) => {
                    console.error("Erro ao buscar fornecedores: ", error);
                    showToast("Não foi possível carregar os fornecedores. Verifique as regras de segurança do Firestore.", "error");
                });
            }

            // --- Lógica de Importação de JSON ---
            const jsonFileInput = document.getElementById('json-file-input');
            const importLoader = document.getElementById('import-loader');
            const modalContent = document.getElementById('modal-content');
            const importProgress = document.getElementById('import-progress');
            const cancelImportBtn = document.getElementById('cancel-import-btn');
            const runInBackgroundBtn = document.getElementById('run-in-background-btn');
            const backgroundImportStatus = document.getElementById('background-import-status');

            closeImportReportBtn.addEventListener('click', () => importReportModal.classList.add('hidden'));
            okImportReportBtn.addEventListener('click', () => importReportModal.classList.add('hidden'));

            cancelImportBtn.addEventListener('click', () => {
                isImportCancelled = true;
                if (isImportingInBackground) {
                    backgroundImportStatus.classList.add('hidden');
                    isImportingInBackground = false;
                }
                showToast('Importação cancelada pelo usuário.', 'info');
            });

            runInBackgroundBtn.addEventListener('click', () => {
                isImportingInBackground = true;
                backgroundImportStatus.classList.remove('hidden');
                closeModal();
                showToast('A importação continuará em segundo plano.', 'info');
            });

            backgroundImportStatus.addEventListener('click', () => {
                if (isImportingInBackground) {
                    supplierModal.classList.remove('hidden');
                    modalTitle.textContent = "Progresso da Importação";
                    modalContent.classList.add('hidden');
                    importLoader.classList.remove('hidden');
                }
            });

            function showImportReport(skipped) {
                if (skipped.length === 0) return;

                let reportHTML = '<ul class="space-y-3">';
                skipped.forEach(item => {
                    reportHTML += `
                        <li class="p-2 border rounded-md bg-gray-50">
                            <p class="font-semibold text-gray-800">${item.nomeFornecedor || 'Nome não informado'}</p>
                            <p><span class="font-medium">CNPJ:</span> ${item.cnpj || 'N/A'}</p>
                            <p><span class="font-medium">Cód:</span> ${item.codFornecedor || 'N/A'}</p>
                            <p class="text-red-600"><span class="font-medium">Motivo:</span> ${item.motivo}</p>
                        </li>
                    `;
                });
                reportHTML += '</ul>';

                importReportContent.innerHTML = reportHTML;
                importReportModal.classList.remove('hidden');
            }

            const startImportProcess = (dataToImport) => {
                isImportCancelled = false;
                modalTitle.textContent = "Progresso da Importação";
                modalContent.classList.add('hidden');
                importLoader.classList.remove('hidden');

                let importedCount = 0;
                const totalToImport = dataToImport.length;

                const processChunk = async () => {
                    if (isImportCancelled) {
                        closeModal();
                        if (isImportingInBackground) {
                            backgroundImportStatus.classList.add('hidden');
                            isImportingInBackground = false;
                        }
                        return;
                    }

                    const batchData = dataToImport.splice(0, 400);
                    if (batchData.length === 0) {
                        showToast(`${importedCount} fornecedor(es) importado(s) com sucesso!`, 'success');
                        closeModal();
                        if (isImportingInBackground) {
                            backgroundImportStatus.classList.add('hidden');
                            isImportingInBackground = false;
                        }
                        return;
                    }

                    const firestoreBatch = writeBatch(db);
                    batchData.forEach(item => {
                        const newDocRef = doc(collection(db, 'suppliers_public'));
                        firestoreBatch.set(newDocRef, item);
                    });

                    await firestoreBatch.commit();
                    importedCount += batchData.length;
                    importProgress.textContent = `Processando ${importedCount} de ${totalToImport}...`;

                    setTimeout(processChunk, 50);
                };

                processChunk();
            };

            cancelImportPreviewBtn.addEventListener('click', () => {
                importPreviewModal.classList.add('hidden');
                importDataCache = null;
            });

            confirmImportBtn.addEventListener('click', () => {
                importPreviewModal.classList.add('hidden');
                if (importDataCache && importDataCache.length > 0) {
                    startImportProcess(importDataCache);
                }
                importDataCache = null;
            });

            jsonFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !auth.currentUser) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        if (!Array.isArray(jsonData)) {
                            throw new Error('O arquivo JSON não contém um array.');
                        }

                        const suppliersInDbCnpj = new Set(suppliers.map(s => s.cnpj));
                        const suppliersInDbCode = new Set(suppliers.map(s => s.code));
                        const seenInFileCnpj = new Set();
                        const seenInFileCode = new Set();
                        const validToImport = [];
                        const duplicates = [];

                        jsonData.forEach(item => {
                            const cnpj = formatCnpj(String(item.cnpj || ''));
                            const code = String(item.codFornecedor || '');

                            if (suppliersInDbCnpj.has(cnpj) || suppliersInDbCode.has(code) || seenInFileCnpj.has(cnpj) || seenInFileCode.has(code)) {
                                duplicates.push(item);
                            } else {
                                validToImport.push({
                                    code: code,
                                    cnpj: cnpj,
                                    name: item.nomeFornecedor || 'N/A',
                                    clientCode: String(item.codCliente || ''),
                                    observations: item.observations || '',
                                    dateTime: item.dateTime || new Date().toISOString()
                                });
                                if (cnpj) seenInFileCnpj.add(cnpj);
                                if (code) seenInFileCode.add(code);
                            }
                        });

                        document.getElementById('preview-total').textContent = jsonData.length;
                        document.getElementById('preview-duplicates').textContent = duplicates.length;
                        document.getElementById('preview-valid').textContent = validToImport.length;

                        importDataCache = validToImport;
                        importPreviewModal.classList.remove('hidden');

                    } catch (error) {
                        showToast(`Erro ao ler o arquivo JSON: ${error.message}`, 'error');
                    } finally {
                        jsonFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- Lógica de Exportação para JSON ---
            const exportDataAsJson = (dataToExport, baseFileName) => {
                if (dataToExport.length === 0) {
                    showToast('Nenhum dado para exportar.', 'info');
                    return;
                }
                const cleanedData = dataToExport.map(({ id, ...rest }) => ({
                    codFornecedor: rest.code || "",
                    cnpj: rest.cnpj || "",
                    nomeFornecedor: rest.name || "",
                    codCliente: rest.clientCode || "",
                    observations: rest.observations || "",
                    dateTime: rest.dateTime || new Date().toISOString()
                }));

                const jsonString = JSON.stringify(cleanedData, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${baseFileName}_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`Exportação de ${dataToExport.length} fornecedor(es) iniciada!`, 'success');
            };

            const exportDataAsXlsx = (dataToExport, baseFileName) => {
                if (dataToExport.length === 0) {
                    showToast('Nenhum dado para exportar.', 'info');
                    return;
                }
                const cleanedData = dataToExport.map(({ id, ...rest }) => ({
                    'Cód. Fornecedor': rest.code || "",
                    'CNPJ': rest.cnpj || "",
                    'Nome Fornecedor': rest.name || "",
                    'Cód. Cliente': rest.clientCode || "",
                    'Observações': rest.observations || "",
                    'Data Cadastro': rest.dateTime || new Date().toISOString()
                }));

                const worksheet = XLSX.utils.json_to_sheet(cleanedData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Fornecedores");
                XLSX.writeFile(workbook, `${baseFileName}_${new Date().toISOString().slice(0, 10)}.xlsx`);
                showToast(`Exportação de ${dataToExport.length} fornecedor(es) iniciada!`, 'success');
            };

            openExportModalBtn.addEventListener('click', () => {
                document.getElementById('export-scope-selected').disabled = selectedSuppliers.size === 0;
                if (selectedSuppliers.size === 0) {
                    document.getElementById('export-scope-all').checked = true;
                }
                exportModal.classList.remove('hidden');
            });

            cancelExportBtn.addEventListener('click', () => {
                exportModal.classList.add('hidden');
            });

            exportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const scope = exportForm.elements['export-scope'].value;
                const type = exportForm.elements['export-type'].value;

                let dataToExport;
                let baseFileName;

                if (scope === 'selected') {
                    const selectedIds = Array.from(selectedSuppliers);
                    dataToExport = suppliers.filter(s => selectedIds.includes(s.id));
                    baseFileName = 'fornecedores_selecionados';
                } else { // 'all'
                    dataToExport = getSortedAndFilteredSuppliers();
                    baseFileName = 'fornecedores_todos';
                }

                if (type === 'json') {
                    exportDataAsJson(dataToExport, baseFileName);
                } else { // 'excel'
                    exportDataAsXlsx(dataToExport, baseFileName);
                }

                exportModal.classList.add('hidden');
            });


            // --- Lógica de Navegação e Views ---
            const views = {
                main: { element: mainView, title: 'Gerenciamento de Fornecedores', button: showMainViewBtn },
                cep: { element: cepSearchView, title: 'Busca por Endereço', button: showCepViewBtn },
                cnpj: { element: cnpjSearchView, title: 'Busca por CNPJ', button: showCnpjViewBtn },
                settings: { element: settingsView, title: 'Configurações', button: showSettingsViewBtn },
            };

            function switchView(viewName) {
                Object.values(views).forEach(view => {
                    view.element.classList.add('hidden');
                    view.button.classList.remove('bg-indigo-600', 'text-white');
                });

                const selectedView = views[viewName];
                selectedView.element.classList.remove('hidden');
                selectedView.button.classList.add('bg-indigo-600', 'text-white');
                headerTitle.textContent = selectedView.title;
                addSupplierBtn.style.display = viewName === 'main' ? 'flex' : 'none';

                headerSearchContainer.classList.add('hidden'); // Oculta por padrão
                headerBulkDeleteContainer.classList.add('hidden'); // Garante que o de deletar some

                if (viewName === 'main') {
                    updateBulkActionsUI(); // Mostra o de deletar se necessário
                }

                if (viewName === 'cnpj' && cnpjSearchPerformed) {
                    headerSearchContainer.classList.remove('hidden'); // Mostra se uma busca já foi feita
                }

                if (viewName === 'settings') {
                    userEmailEl.textContent = auth.currentUser?.email || 'N/A';
                }
            }

            showMainViewBtn.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
            showCepViewBtn.addEventListener('click', (e) => { e.preventDefault(); switchView('cep'); });
            showCnpjViewBtn.addEventListener('click', (e) => { e.preventDefault(); switchView('cnpj'); });
            showSettingsViewBtn.addEventListener('click', (e) => { e.preventDefault(); switchView('settings'); });

            // --- Lógica da Sidebar ---
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('w-64');
                sidebar.classList.toggle('w-20');
                logoText.classList.toggle('opacity-100');
                logoText.classList.toggle('opacity-0');
                sidebarItemsText.forEach(text => {
                    text.classList.toggle('opacity-100');
                    text.classList.toggle('opacity-0');
                });
            });

            // --- Lógica do Modal de Fornecedor ---
            window.openModal = (supplierId = null) => {
                supplierForm.reset();
                modalTitle.textContent = "Cadastrar Novo Fornecedor";
                modalContent.classList.remove('hidden');
                importLoader.classList.add('hidden');
                if (supplierId) {
                    const supplier = suppliers.find(s => s.id === supplierId);
                    if (!supplier) return;
                    modalTitle.textContent = 'Editar Fornecedor';
                    document.querySelector('#supplierModal button[type="submit"]').textContent = 'Salvar Alterações';
                    editSupplierIdInput.value = supplier.id;
                    document.getElementById('supplierCode').value = supplier.code;
                    document.getElementById('supplierCnpj').value = supplier.cnpj;
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('clientCode').value = supplier.clientCode || '';
                    document.getElementById('observations').value = supplier.observations || '';
                    nameInput.readOnly = false;
                    nameInput.classList.remove('bg-gray-100');
                } else {
                    modalTitle.textContent = 'Cadastrar Novo Fornecedor';
                    document.querySelector('#supplierModal button[type="submit"]').textContent = 'Salvar Fornecedor';
                    editSupplierIdInput.value = '';
                    nameInput.readOnly = true;
                    nameInput.classList.add('bg-gray-100');
                }
                supplierModal.classList.remove('hidden');
                supplierModal.setAttribute('aria-hidden', 'false');
            };

            const closeModal = () => {
                supplierModal.classList.add('hidden');
                supplierModal.setAttribute('aria-hidden', 'true');
                supplierForm.reset();
                editSupplierIdInput.value = '';
                nameInput.readOnly = true;
                nameInput.classList.add('bg-gray-100');
                modalContent.classList.remove('hidden');
                importLoader.classList.add('hidden');
                isImportCancelled = false;
            };

            addSupplierBtn.addEventListener('click', () => openModal(null));
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            let mouseDownOnBackdrop = false;
            supplierModal.addEventListener('mousedown', (event) => {
                if (event.target === supplierModal) {
                    mouseDownOnBackdrop = true;
                }
            });
            supplierModal.addEventListener('mouseup', (event) => {
                if (mouseDownOnBackdrop && event.target === supplierModal) {
                    closeModal();
                }
                mouseDownOnBackdrop = false;
            });
            supplierModal.addEventListener('mouseleave', () => {
                mouseDownOnBackdrop = false;
            });

            // --- Lógica de Submissão do Formulário de Fornecedor ---
            const saveSupplier = async (supplierData, supplierId = null) => {
                if (!auth.currentUser) {
                    showToast('Você precisa estar logado para salvar.', 'error');
                    return;
                }
                try {
                    if (supplierId) {
                        const supplierDocRef = doc(db, 'suppliers_public', supplierId);
                        await updateDoc(supplierDocRef, supplierData);
                        showToast('Fornecedor atualizado com sucesso!', 'success');
                    } else {
                        await addDoc(collection(db, 'suppliers_public'), supplierData);
                        showToast('Fornecedor cadastrado com sucesso!', 'success');
                    }
                    closeModal();
                } catch (error) {
                    console.error("Erro ao salvar: ", error);
                    showToast('Erro ao salvar fornecedor.', 'error');
                }
            }

            supplierForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(supplierForm);
                const supplierId = formData.get('editSupplierId');
                const supplierData = {
                    code: formData.get('supplierCode'),
                    cnpj: formData.get('supplierCnpj'),
                    name: formData.get('supplierName'),
                    clientCode: formData.get('clientCode'),
                    observations: formData.get('observations'),
                };

                if (!supplierId) {
                    supplierData.dateTime = new Date().toISOString();
                    const isDuplicate = suppliers.some(s => s.cnpj === supplierData.cnpj || s.code === supplierData.code);
                    if (isDuplicate) {
                        duplicateConfirmCallback = () => saveSupplier(supplierData);
                        confirmDuplicateModal.classList.remove('hidden');
                        return;
                    }
                }

                saveSupplier(supplierData, supplierId);
            });

            cnpjInput.addEventListener('input', async (e) => {
                const cnpj = e.target.value.replace(/\D/g, '');
                if (cnpj.length < 14) {
                    nameInput.value = '';
                    nameInput.readOnly = true;
                    nameInput.classList.add('bg-gray-100');
                    return;
                }
                if (cnpj.length === 14) {
                    cnpjLoader.classList.remove('hidden');
                    nameInput.value = 'Buscando...';
                    try {
                        const response = await fetch(`${corsProxy}https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => null);
                            throw { status: response.status, data: errorData };
                        }
                        const data = await response.json();
                        nameInput.value = data.razao_social || '';
                        nameInput.readOnly = false;
                        nameInput.classList.remove('bg-gray-100');
                    } catch (error) {
                        handleApiError(error, 'Busca de CNPJ no Modal');
                        nameInput.value = '';
                        nameInput.readOnly = false;
                        nameInput.classList.remove('bg-gray-100');
                    } finally {
                        cnpjLoader.classList.add('hidden');
                    }
                }
            });

            // --- Lógica de Ordenação e Filtro da Tabela ---
            function getSortedAndFilteredSuppliers() {
                const searchTerm = searchFilter.toLowerCase().trim();
                let filteredSuppliers = suppliers;

                if (searchTerm) {
                    filteredSuppliers = suppliers.filter(supplier => {
                        const cleanCnpj = (supplier.cnpj || '').replace(/\D/g, '');
                        const cleanSearchTerm = searchTerm.replace(/\D/g, '');

                        if (searchColumn === 'all') {
                            return (
                                (supplier.code || '').toLowerCase().includes(searchTerm) ||
                                (supplier.name || '').toLowerCase().includes(searchTerm) ||
                                (supplier.clientCode || '').toLowerCase().includes(searchTerm) ||
                                (supplier.observations || '').toLowerCase().includes(searchTerm) ||
                                (cleanCnpj.includes(cleanSearchTerm) && cleanSearchTerm.length > 0)
                            );
                        } else {
                            const columnValue = supplier[searchColumn] || '';
                            if (searchColumn === 'cnpj') {
                                return columnValue.replace(/\D/g, '').includes(cleanSearchTerm);
                            }
                            return String(columnValue).toLowerCase().includes(searchTerm);
                        }
                    });
                }

                const sorted = [...filteredSuppliers].sort((a, b) => {
                    const key = sortConfig.key;
                    const direction = sortConfig.direction === 'asc' ? 1 : -1;

                    let valA = a[key];
                    let valB = b[key];

                    if (key === 'dateTime') {
                        valA = valA ? new Date(valA).getTime() : 0;
                        valB = valB ? new Date(valB).getTime() : 0;
                        return (valA - valB) * direction;
                    }
                    if (key === 'code') {
                        return (Number(valA) - Number(valB)) * direction;
                    }

                    return String(valA || '').localeCompare(String(valB || ''), 'pt-BR', { sensitivity: 'base' }) * direction;
                });
                return sorted;
            }

            supplierSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    searchFilter = e.target.value;
                    currentPage = 1;
                    renderTable();
                }, 300);
            });

            tableHead.addEventListener('click', (e) => {
                const header = e.target.closest('[data-sort-key]');
                if (!header) return;

                const key = header.dataset.sortKey;
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'asc';
                }

                currentPage = 1;
                renderTable();
            });

            // --- Lógica de Cópia da Tabela ---
            supplierTableBody.addEventListener('click', (e) => {
                const cell = e.target.closest('td.copyable-cell');
                if (cell) {
                    const textToCopy = cell.textContent.trim();
                    if (textToCopy) {
                        copyToClipboard(textToCopy);
                    }
                }
            });


            // --- Lógica de Renderização da Tabela ---
            function renderTable() {
                document.querySelectorAll('thead th[data-sort-key]').forEach(th => {
                    const icon = th.querySelector('ion-icon');
                    if (th.dataset.sortKey === sortConfig.key) {
                        icon.name = sortConfig.direction === 'asc' ? 'caret-up-outline' : 'caret-down-outline';
                        icon.classList.remove('opacity-50');
                    } else {
                        icon.name = 'caret-down-outline';
                        icon.classList.add('opacity-50');
                    }
                });

                supplierTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-10">
                            <div class="flex justify-center items-center space-x-2 text-gray-500">
                                <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>Carregando dados...</span>
                            </div>
                        </td>
                    </tr>
                `;

                setTimeout(() => {
                    const processedSuppliers = getSortedAndFilteredSuppliers();
                    supplierTableBody.innerHTML = '';
                    const start = (currentPage - 1) * ROWS_PER_PAGE;
                    const end = start + ROWS_PER_PAGE;
                    const paginatedSuppliers = processedSuppliers.slice(start, end);

                    if (processedSuppliers.length === 0) {
                        supplierTableBody.innerHTML = `<tr id="no-suppliers-row"><td colspan="8" class="text-center py-10 text-gray-500"><ion-icon name="file-tray-outline" class="text-4xl mx-auto"></ion-icon><p class="mt-2">Nenhum fornecedor encontrado.</p></td></tr>`;
                    } else {
                        paginatedSuppliers.forEach(supplier => {
                            const isChecked = selectedSuppliers.has(supplier.id);
                            const tr = document.createElement('tr');
                            tr.className = `border-b hover:bg-gray-50 ${isChecked ? 'bg-indigo-50' : ''}`;
                            tr.innerHTML = `
                                <td class="py-1 px-4 w-12"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-id="${supplier.id}" ${isChecked ? 'checked' : ''}></td>
                                <td class="py-1 px-4 copyable-cell whitespace-nowrap">${supplier.code}</td>
                                <td class="py-1 px-4 copyable-cell">${supplier.cnpj}</td>
                                <td class="py-1 px-4 font-medium copyable-cell">${supplier.name}</td>
                                <td class="py-1 px-4 copyable-cell">${supplier.clientCode || ''}</td>
                                <td class="py-1 px-4 text-sm text-gray-500 max-w-[200px] truncate copyable-cell" title="${supplier.observations || ''}">${supplier.observations || ''}</td>
                                <td class="py-1 px-4">
                                    <div class="flex space-x-2">
                                        <button onclick="openModal('${supplier.id}')" class="text-indigo-600 hover:text-indigo-800 p-1" title="Editar Fornecedor"><ion-icon name="create-outline"></ion-icon></button>
                                    </div>
                                </td>
                                <td class="py-1 px-4">
                                    <button onclick="showInfoModal('${supplier.id}')" class="text-gray-500 hover:text-blue-600 p-1" title="Ver Detalhes"><ion-icon name="information-circle-outline" class="text-xl"></ion-icon></button>
                                </td>
                            `;
                            supplierTableBody.appendChild(tr);
                        });
                    }
                    renderPagination(processedSuppliers.length);
                    updateSelectAllCheckboxState();
                    updateBulkActionsUI();
                }, 10);
            }

            // --- Lógica do Dropdown de Filtro ---
            function toggleFilterDropdown(show) {
                if (show) {
                    filterColumnList.classList.remove('hidden');
                    setTimeout(() => {
                        filterColumnList.classList.remove('opacity-0', 'scale-95');
                    }, 10);
                } else {
                    filterColumnList.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        filterColumnList.classList.add('hidden');
                    }, 200);
                }
            }

            filterColumnBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = filterColumnList.classList.contains('hidden');
                toggleFilterDropdown(isHidden);
            });

            window.addEventListener('click', (e) => {
                if (!filterColumnBtn.contains(e.target)) {
                    toggleFilterDropdown(false);
                }
            });

            filterColumnList.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;

                    searchColumn = value;
                    filterColumnText.textContent = text;
                    localStorage.setItem('searchColumnPreference', JSON.stringify({ value, text }));

                    toggleFilterDropdown(false);
                    renderTable();
                }
            });

            clearFilterBtn.addEventListener('click', () => {
                supplierSearchInput.value = '';
                searchFilter = '';
                currentPage = 1;
                renderTable();
                showToast('Filtro limpo.', 'info');
            });

            function loadFilterSettings() {
                const savedPreference = localStorage.getItem('searchColumnPreference');
                if (savedPreference) {
                    try {
                        const { value, text } = JSON.parse(savedPreference);
                        searchColumn = value;
                        filterColumnText.textContent = text;
                    } catch (e) {
                        searchColumn = 'all';
                        filterColumnText.textContent = 'Todas as Colunas';
                    }
                }
            }


            // --- Lógica de Paginação e Exclusão em Massa ---
            function renderPagination(totalItems) {
                paginationControls.innerHTML = '';
                const totalPages = Math.ceil(totalItems / ROWS_PER_PAGE);

                if (totalItems === 0) return;

                const infoHTML = `<div class="text-sm text-gray-600">Mostrando ${Math.min(totalItems, 1 + (currentPage - 1) * ROWS_PER_PAGE)} a ${Math.min(currentPage * ROWS_PER_PAGE, totalItems)} de ${totalItems}</div>`;

                if (totalPages <= 1) {
                    paginationControls.innerHTML = infoHTML;
                    return;
                }

                let buttonsHTML = `<div class="flex items-center">`;
                buttonsHTML += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-1 mx-1 rounded-md text-sm font-medium ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>`;

                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (startPage > 1) {
                    buttonsHTML += `<button onclick="changePage(1)" class="px-3 py-1 mx-1 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100">1</button>`;
                    if (startPage > 2) {
                        buttonsHTML += `<span class="px-3 py-1 mx-1 text-sm font-medium text-gray-500">...</span>`;
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    if (i === currentPage) {
                        buttonsHTML += `<button class="px-3 py-1 mx-1 rounded-md text-sm font-medium bg-indigo-600 text-white">${i}</button>`;
                    } else {
                        buttonsHTML += `<button onclick="changePage(${i})" class="px-3 py-1 mx-1 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100">${i}</button>`;
                    }
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        buttonsHTML += `<span class="px-3 py-1 mx-1 text-sm font-medium text-gray-500">...</span>`;
                    }
                    buttonsHTML += `<button onclick="changePage(${totalPages})" class="px-3 py-1 mx-1 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100">${totalPages}</button>`;
                }

                buttonsHTML += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-1 mx-1 rounded-md text-sm font-medium ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${currentPage === totalPages ? 'disabled' : ''}>Próximo</button>`;
                buttonsHTML += `</div>`;

                paginationControls.innerHTML = `${infoHTML} ${buttonsHTML}`;
            }

            window.changePage = (newPage) => {
                const totalItems = getSortedAndFilteredSuppliers().length;
                const totalPages = Math.ceil(totalItems / ROWS_PER_PAGE);
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderTable();
                }
            }

            function updateBulkActionsUI() {
                if (selectedSuppliers.size > 0 && mainView.style.display !== 'none') {
                    headerBulkDeleteContainer.classList.remove('hidden');
                    bulkDeleteBtnHeader.querySelector('span').textContent = `Excluir ${selectedSuppliers.size}`;
                } else {
                    headerBulkDeleteContainer.classList.add('hidden');
                }
            }

            function updateSelectAllCheckboxState() {
                const processedSuppliers = getSortedAndFilteredSuppliers();
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                const paginatedSuppliers = processedSuppliers.slice(start, end);

                if (selectAllMode === 'all') {
                    const allFilteredCount = processedSuppliers.length;
                    const allFilteredAreSelected = allFilteredCount > 0 && processedSuppliers.every(s => selectedSuppliers.has(s.id));
                    selectAllCheckbox.checked = allFilteredAreSelected;
                } else { // 'page' mode
                    const totalOnPage = paginatedSuppliers.length;
                    const selectedOnPage = paginatedSuppliers.filter(s => selectedSuppliers.has(s.id)).length;
                    selectAllCheckbox.checked = totalOnPage > 0 && totalOnPage === selectedOnPage;
                }
            }

            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                if (selectAllMode === 'all') {
                    const allFilteredIds = getSortedAndFilteredSuppliers().map(s => s.id);
                    if (isChecked) {
                        allFilteredIds.forEach(id => selectedSuppliers.add(id));
                    } else {
                        selectedSuppliers.clear();
                    }
                } else { // mode === 'page'
                    const checkboxesOnPage = document.querySelectorAll('.row-checkbox');
                    checkboxesOnPage.forEach(checkbox => {
                        const id = checkbox.dataset.id;
                        if (isChecked) {
                            selectedSuppliers.add(id);
                        } else {
                            selectedSuppliers.delete(id);
                        }
                    });
                }
                renderTable();
            });

            supplierTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('row-checkbox')) {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedSuppliers.add(id);
                    } else {
                        selectedSuppliers.delete(id);
                    }
                    e.target.closest('tr').classList.toggle('bg-indigo-50', e.target.checked);
                    updateBulkActionsUI();
                    updateSelectAllCheckboxState();
                }
            });

            // Lógica do Modal de Confirmação de Exclusão
            cancelDeleteBtn.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
                deleteConfirmCallback = null;
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (typeof deleteConfirmCallback === 'function') {
                    deleteConfirmCallback();
                }
                confirmDeleteModal.classList.add('hidden');
                deleteConfirmCallback = null;
            });

            bulkDeleteBtnHeader.addEventListener('click', () => {
                if (selectedSuppliers.size === 0) return;

                confirmMessage.textContent = `Você tem certeza que deseja excluir ${selectedSuppliers.size} fornecedor(es) selecionado(s)?`;

                deleteConfirmCallback = async () => {
                    if (!auth.currentUser) return;

                    const deletePromises = Array.from(selectedSuppliers).map(id => deleteDoc(doc(db, 'suppliers_public', id)));
                    const totalDeleted = selectedSuppliers.size;
                    try {
                        await Promise.all(deletePromises);
                        showToast(`${totalDeleted} fornecedor(es) removido(s).`, 'info');
                    } catch (error) {
                        showToast('Erro ao remover fornecedores.', 'error');
                    } finally {
                        selectedSuppliers.clear();
                        renderTable();
                    }
                };

                confirmDeleteModal.classList.remove('hidden');
            });


            // Lógica do Modal de Confirmação de Duplicidade
            cancelDuplicateBtn.addEventListener('click', () => {
                confirmDuplicateModal.classList.add('hidden');
                duplicateConfirmCallback = null;
            });

            confirmDuplicateBtn.addEventListener('click', () => {
                if (typeof duplicateConfirmCallback === 'function') {
                    duplicateConfirmCallback();
                }
                confirmDuplicateModal.classList.add('hidden');
                duplicateConfirmCallback = null;
            });

            // --- Lógica de Configurações ---
            function loadSettings() {
                const savedMode = localStorage.getItem('selectAllMode') || 'page';
                selectAllMode = savedMode;
                if (savedMode === 'all') {
                    selectModeAllRadio.checked = true;
                } else {
                    selectModePageRadio.checked = true;
                }

                const savedRows = localStorage.getItem('rowsPerPage') || '50';
                ROWS_PER_PAGE = parseInt(savedRows, 10);
                rowsPerPageSelect.value = savedRows;
            }

            selectModePageRadio.addEventListener('change', () => {
                if (selectModePageRadio.checked) {
                    selectAllMode = 'page';
                    localStorage.setItem('selectAllMode', 'page');
                    showToast('Seleção alterada para "Página Atual"', 'info');
                }
            });

            selectModeAllRadio.addEventListener('change', () => {
                if (selectModeAllRadio.checked) {
                    selectAllMode = 'all';
                    localStorage.setItem('selectAllMode', 'all');
                    showToast('Seleção alterada para "Todos os Itens"', 'info');
                }
            });

            rowsPerPageSelect.addEventListener('change', () => {
                ROWS_PER_PAGE = parseInt(rowsPerPageSelect.value, 10);
                localStorage.setItem('rowsPerPage', ROWS_PER_PAGE);
                currentPage = 1;
                renderTable();
                showToast(`Exibindo ${ROWS_PER_PAGE} linhas por página.`, 'info');
            });

            resetPasswordBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    showToast('Você precisa estar logado para redefinir a senha.', 'error');
                    return;
                }
                try {
                    await sendPasswordResetEmail(auth, user.email);
                    showToast(`E-mail de redefinição enviado para ${user.email}`, 'success');
                } catch (error) {
                    console.error("Erro ao enviar e-mail de redefinição:", error);
                    showToast('Falha ao enviar e-mail de redefinição. Tente novamente.', 'error');
                }
            });

            // --- NOVO: Lógica do Modal de Informações ---
            closeInfoModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));
            okInfoModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));

            window.showInfoModal = (supplierId) => {
                const supplier = suppliers.find(s => s.id === supplierId);
                if (!supplier) {
                    showToast('Fornecedor não encontrado.', 'error');
                    return;
                }

                infoModalContent.innerHTML = `
                    <div class="grid grid-cols-3 gap-x-4 gap-y-2">
                        <p class="font-semibold text-gray-600 col-span-1">Cód. Fornecedor:</p>
                        <p class="text-gray-800 col-span-2">${supplier.code || 'N/A'}</p>

                        <p class="font-semibold text-gray-600 col-span-1">CNPJ:</p>
                        <p class="text-gray-800 col-span-2">${supplier.cnpj || 'N/A'}</p>

                        <p class="font-semibold text-gray-600 col-span-1">Nome:</p>
                        <p class="text-gray-800 col-span-2">${supplier.name || 'N/A'}</p>

                        <p class="font-semibold text-gray-600 col-span-1">Cód. Cliente:</p>
                        <p class="text-gray-800 col-span-2">${supplier.clientCode || 'N/A'}</p>
                        
                        <p class="font-semibold text-gray-600 col-span-1">Data de Cadastro:</p>
                        <p class="text-gray-800 col-span-2">${formatSupplierDate(supplier.dateTime)}</p>

                        <p class="font-semibold text-gray-600 col-span-1">Observações:</p>
                        <p class="text-gray-800 col-span-2 break-words">${supplier.observations || 'N/A'}</p>
                    </div>
                `;
                infoModal.classList.remove('hidden');
            };


            // --- Tratamento de Erros de API ---
            function handleApiError(error, context) {
                console.error(`Erro em ${context}:`, error);
                let message = `Ocorreu um erro inesperado em '${context}'.`;

                if (error instanceof TypeError) { // Erro de rede
                    message = "Falha na conexão. Verifique sua internet.";
                } else if (error && error.status) { // Erro de HTTP
                    switch (error.status) {
                        case 400:
                            message = `Requisição inválida para ${context}. Verifique os dados enviados.`;
                            break;
                        case 404:
                            message = `${context}: O CEP ou CNPJ informado não foi encontrado.`;
                            break;
                        case 429:
                            message = `Muitas solicitações para ${context}. Tente novamente em alguns instantes.`;
                            break;
                        default:
                            message = `Erro ${error.status} ao consultar ${context}. Tente mais tarde.`;
                    }
                }
                showToast(message, 'error');
            }

            // --- Lógica de Busca de CEP ---
            tabByCep.addEventListener('click', () => {
                tabByAddress.classList.remove('border-indigo-500', 'text-indigo-600');
                tabByAddress.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabByCep.classList.add('border-indigo-500', 'text-indigo-600');
                tabByCep.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                addressForm.classList.add('hidden');
                cepForm.classList.remove('hidden');
            });

            tabByAddress.addEventListener('click', () => {
                tabByCep.classList.remove('border-indigo-500', 'text-indigo-600');
                tabByCep.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabByAddress.classList.add('border-indigo-500', 'text-indigo-600');
                tabByAddress.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                cepForm.classList.add('hidden');
                addressForm.classList.remove('hidden');
            });

            cepInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                e.target.value = value.slice(0, 9);
            });

            cepForm.addEventListener('submit', (e) => {
                e.preventDefault();
                searchByCep(cepInput.value);
            });

            addressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><p>Buscando...</p></div>`;

                const uf = ufInput.value.trim();
                const city = cityInput.value.trim();
                const street = expandStreetAbbreviations(streetInput.value.trim());

                if (street.length < 3) {
                    cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-red-500"><p>O nome do logradouro deve ter pelo menos 3 caracteres.</p></div>`;
                    return;
                }

                const encodedUf = encodeURIComponent(uf);
                const encodedCity = encodeURIComponent(city);
                const encodedStreet = encodeURIComponent(street);

                try {
                    const response = await fetch(`${corsProxy}https://viacep.com.br/ws/${encodedUf}/${encodedCity}/${encodedStreet}/json/`);
                    if (!response.ok) throw { status: response.status };

                    const data = await response.json();
                    if (data.erro || data.length === 0) {
                        cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><p>Nenhum endereço encontrado com os critérios informados.</p></div>`;
                        return;
                    }

                    if (data.length === 1) {
                        renderViaCepResult(data[0]);
                        return;
                    }

                    let resultHTML = `<div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-semibold text-lg mb-4 text-gray-700">Resultados Encontrados (${data.length}) - Clique para ver detalhes</h3><div class="space-y-2 max-h-80 overflow-y-auto">`;
                    data.forEach(addr => {
                        const formattedCep = addr.cep.replace(/(\d{5})(\d{3})/, '$1-$2');
                        resultHTML += `
                            <div class="address-list-item p-3 border rounded-md" data-cep="${addr.cep.replace(/\D/g, '')}">
                                <p class="font-medium text-gray-800">${addr.logradouro.toUpperCase()}</p>
                                <p class="text-sm text-gray-600">${addr.bairro.toUpperCase()}, ${addr.localidade.toUpperCase()} - ${addr.uf}</p>
                                <p class="text-sm font-semibold text-indigo-600">${formattedCep}</p>
                            </div>
                        `;
                    });
                    resultHTML += '</div></div>';
                    cepResultDiv.innerHTML = resultHTML;

                } catch (error) {
                    handleApiError(error, 'Busca por Endereço');
                    cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-red-500"><p>Endereço não encontrado. Verifique os dados e tente novamente.</p></div>`;
                }
            });

            cepResultDiv.addEventListener('click', (e) => {
                const addressItem = e.target.closest('.address-list-item');
                if (addressItem && addressItem.dataset.cep) {
                    searchByCep(addressItem.dataset.cep);
                }
            });

            // --- Lógica de Busca de CNPJ ---
            newCnpjSearchBtn.addEventListener('click', () => {
                cnpjSearchContainer.classList.remove('hidden');
                headerSearchContainer.classList.add('hidden');
                cnpjResultDiv.innerHTML = '';
                viewCnpjInput.value = '';
                viewCnpjInput.focus();
                cnpjSearchPerformed = false;
            });

            cnpjSearchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                performCnpjSearch(viewCnpjInput.value);
            });

            const performCnpjSearch = async (cnpjValue) => {
                const cnpj = cnpjValue.replace(/\D/g, '');
                if (cnpj.length !== 14) {
                    showToast('CNPJ inválido. Deve conter 14 dígitos.', 'error');
                    return;
                }

                cnpjResultDiv.innerHTML = `<div class="flex items-center justify-center text-gray-500 h-full"><p>Buscando...</p></div>`;
                try {
                    const response = await fetch(`${corsProxy}https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw { status: response.status, data: errorData };
                    }
                    const data = await response.json();

                    cnpjSearchPerformed = true;
                    cnpjSearchContainer.classList.add('hidden');
                    headerSearchContainer.classList.remove('hidden');

                    const cleanCnpj = data.cnpj.replace(/\D/g, '');
                    const cnpjaUrl = `https://cnpja.com/office/${cleanCnpj}`;

                    const status = data.descricao_situacao_cadastral;
                    let statusHtml = '';
                    if (status === 'ATIVA') {
                        statusHtml = `
                            <div class="flex items-center gap-2 text-sm font-medium ml-3">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" fill="#22C55E"></circle>
                                    <path d="M8.5 12.5L11 15L15.5 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="text-green-700">Ativa</span>
                            </div>`;
                    } else if (status === 'BAIXADA') {
                        statusHtml = `
                            <div class="flex items-center gap-4 ml-3">
                                <div class="flex items-center gap-2 text-sm font-medium">
                                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="12" cy="12" r="10" fill="#EF4444"></circle>
                                        <path d="M15 9L9 15M9 9L15 15" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span class="text-red-700">Baixada</span>
                                </div>
                                <div class="flex items-center gap-1.5 text-xs text-gray-500">
                                    <ion-icon name="calendar-outline"></ion-icon>
                                    <span>${formatDate(data.data_situacao_cadastral)}</span>
                                </div>
                            </div>`;
                    }

                    const renderCnaes = (cnaes) => {
                        if (!cnaes || cnaes.length === 0) return '<p class="text-gray-500">Nenhuma atividade secundária encontrada.</p>';
                        return cnaes.map(cnae => createStyledField('ellipse-outline', cnae.codigo, cnae.descricao, true)).join('');
                    }

                    cnpjResultDiv.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                               <div class="flex flex-wrap justify-between items-start gap-4">
                                   <div>
                                        <div class="flex items-center gap-3 mb-1">
                                            <ion-icon name="business-outline" class="text-2xl text-gray-600"></ion-icon>
                                            <h3 class="text-xl font-bold text-gray-800">${data.razao_social}</h3>
                                            ${statusHtml}
                                        </div>
                                        <p class="text-sm text-gray-500 pl-9">${data.nome_fantasia || 'Sem nome fantasia'}</p>
                                   </div>
                                   <a href="${cnpjaUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-700 flex items-center space-x-2 whitespace-nowrap">
                                        <ion-icon name="open-outline"></ion-icon>
                                        <span>Consulta Completa</span>
                                   </a>
                               </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <div class="lg:col-span-2 space-y-4">
                                    <div class="bg-white p-6 rounded-xl shadow-sm">
                                        <h4 class="font-semibold text-lg mb-4 text-gray-700 border-b pb-2">Dados Gerais</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 pt-4 text-sm">
                                            ${createStyledField('business-outline', 'CNPJ', formatCnpj(data.cnpj))}
                                            ${createStyledField('information-circle-outline', 'Situação Cadastral', `${data.descricao_situacao_cadastral} desde ${formatDate(data.data_situacao_cadastral)}`)}
                                            ${createStyledField('calendar-outline', 'Data de Abertura', formatDate(data.data_inicio_atividade))}
                                            ${createStyledField('expand-outline', 'Porte', data.porte)}
                                            ${createStyledField('call-outline', 'Telefone', formatPhone(data.ddd_telefone_1) || 'Não informado')}
                                            ${createStyledField('mail-outline', 'E-mail', data.email || 'Não informado')}
                                            ${createStyledField('document-text-outline', 'Natureza Jurídica', data.natureza_juridica)}
                                            ${createStyledField('cash-outline', 'Capital Social', Number(data.capital_social).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }))}
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-sm">
                                        <h4 class="font-semibold text-lg mb-4 text-gray-700 border-b pb-2">Endereço</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 pt-4 text-sm">
                                            ${createStyledField('location-outline', 'Logradouro', `${data.logradouro}, ${data.numero}`)}
                                            ${createStyledField('cube-outline', 'Complemento', data.complemento)}
                                            ${createStyledField('map-outline', 'Bairro', data.bairro)}
                                            ${createStyledField('trail-sign-outline', 'Município / UF', `${data.municipio} / ${data.uf}`)}
                                            ${createStyledField('locate-outline', 'CEP', data.cep.replace(/(\d{5})(\d{3})/, '$1-$2'))}
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <div class="bg-white p-6 rounded-xl shadow-sm">
                                        <h4 class="font-semibold text-lg mb-4 text-gray-700 border-b pb-2">Atividade Principal (CNAE)</h4>
                                        <div class="pt-4 text-sm">
                                            ${createStyledField('briefcase-outline', data.cnae_fiscal, data.cnae_fiscal_descricao, true)}
                                        </div>
                                    </div>
                                     <div class="bg-white p-6 rounded-xl shadow-sm">
                                        <h4 class="font-semibold text-lg mb-4 text-gray-700 border-b pb-2">Atividades Secundárias</h4>
                                        <div class="pt-4 text-sm space-y-3 max-h-48 overflow-y-auto">
                                            ${renderCnaes(data.cnaes_secundarios)}
                                        </div>
                                    </div>
                                     <div class="bg-white p-6 rounded-xl shadow-sm">
                                        <h4 class="font-semibold text-lg mb-4 text-gray-700 border-b pb-2">Quadro Societário</h4>
                                        <div class="pt-4 text-sm space-y-3 max-h-60 overflow-y-auto">
                                            ${data.qsa && data.qsa.length > 0 ? data.qsa.map(socio => createStyledField('person-circle-outline', socio.nome_socio, socio.qualificacao_socio)).join('') : '<p class="text-gray-500">Nenhum sócio encontrado.</p>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } catch (error) {
                    handleApiError(error, 'Busca de CNPJ');
                    cnpjResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-red-500"><p>Falha ao buscar CNPJ. Verifique o número e tente novamente.</p></div>`;
                }
            };

            viewCnpjInput.addEventListener('input', (e) => { e.target.value = formatCnpj(e.target.value); });
            cnpjInput.addEventListener('input', (e) => { e.target.value = formatCnpj(e.target.value); });


            document.addEventListener('keydown', (e) => {
                let shortcut_triggered = false;

                if (e.ctrlKey && e.key.toLowerCase() === 'g') {
                    shortcut_triggered = true;
                    openModal(null);
                }

                if (e.ctrlKey && e.key.toLowerCase() === 'f') {
                    shortcut_triggered = true;
                    switchView('main');
                    setTimeout(() => supplierSearchInput.focus(), 50);
                }

                if (e.ctrlKey && e.key.toLowerCase() === 's') {
                    shortcut_triggered = true;
                    switchView('cep');
                    setTimeout(() => {
                        tabByCep.click();
                        cepInput.focus();
                    }, 50);
                }

                if (e.ctrlKey && e.key.toLowerCase() === 'a') {
                    shortcut_triggered = true;
                    switchView('cep');
                    setTimeout(() => {
                        tabByAddress.click();
                        streetInput.focus();
                    }, 50);
                }

                if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                    shortcut_triggered = true;
                    if (views.cnpj.element.classList.contains('hidden')) {
                        switchView('cnpj');
                    }

                    if (cnpjSearchPerformed) {
                        newCnpjSearchBtn.click();
                    } else {
                        setTimeout(() => viewCnpjInput.focus(), 50);
                    }
                }

                if (shortcut_triggered) {
                    e.preventDefault();
                }
            });


            // --- Funções Utilitárias ---
            function expandStreetAbbreviations(street) {
                if (!street) return '';
                let processedStreet = street.trim();
                const abbreviations = [
                    { pattern: /^rod\./i, replacement: 'Rodovia' },
                    { pattern: /^rod\b/i, replacement: 'Rodovia' },
                    { pattern: /^av\./i, replacement: 'Avenida' },
                    { pattern: /^av\b/i, replacement: 'Avenida' },
                    { pattern: /^pr\./i, replacement: 'Praça' },
                    { pattern: /^pr\b/i, replacement: 'Praça' },
                    { pattern: /^r\./i, replacement: 'Rua' },
                    { pattern: /^r\b/i, replacement: 'Rua' },
                    { pattern: /^p\./i, replacement: 'Praça' },
                    { pattern: /^p\b/i, replacement: 'Praça' }
                ];

                for (const rule of abbreviations) {
                    if (rule.pattern.test(processedStreet)) {
                        processedStreet = processedStreet.replace(rule.pattern, rule.replacement);
                        break;
                    }
                }
                return processedStreet;
            }

            function renderViaCepResult(data) {
                const formattedCep = data.cep.replace(/(\d{5})(\d{3})/, '$1-$2');
                const fullAddress = `${data.logradouro} - ${data.bairro}, ${data.localidade} - ${data.uf}, ${formattedCep}`;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;

                cepResultDiv.innerHTML = `
                     <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center pb-4 border-b">
                           <div>
                                <h3 class="text-xl font-bold text-gray-800 uppercase">${data.logradouro}</h3>
                                <p class="text-sm text-gray-500 uppercase">${data.bairro}, ${data.localidade} - ${data.uf}</p>
                           </div>
                           <a href="${mapsUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-700 flex items-center space-x-2 whitespace-nowrap">
                                <ion-icon name="map-outline"></ion-icon>
                                <span>Ver no Mapa</span>
                           </a>
                        </div>
                        <div class="py-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                                ${createCopyableField('Logradouro', data.logradouro.toUpperCase())}
                                ${createCopyableField('Bairro', data.bairro.toUpperCase())}
                                ${createCopyableField('Cidade', data.localidade.toUpperCase())}
                                ${createCopyableField('Estado', data.uf.toUpperCase())}
                                ${createCopyableField('CEP', formattedCep)}
                                ${createCopyableField('IBGE', data.ibge)}
                            </div>
                             <div class="mt-4 pt-4 border-t">
                                ${createStyledField('navigate-outline', 'Endereço Completo', fullAddress.toUpperCase())}
                            </div>
                        </div>
                    </div>`;
            }

            async function searchByCep(cep) {
                const cleanedCep = cep.replace(/\D/g, '');
                if (cleanedCep.length !== 8) {
                    showToast('CEP inválido. Deve conter 8 dígitos.', 'error');
                    return;
                }
                cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><p>Buscando...</p></div>`;
                try {
                    const response = await fetch(`${corsProxy}https://viacep.com.br/ws/${cleanedCep}/json/`);
                    if (!response.ok) throw { status: response.status };

                    const data = await response.json();
                    if (data.erro) {
                        throw { status: 404 };
                    }
                    renderViaCepResult(data);
                } catch (error) {
                    handleApiError(error, 'Busca por CEP');
                    cepResultDiv.innerHTML = `<div class="flex items-center justify-center h-full text-red-500"><p>Falha ao buscar CEP. Verifique o número e tente novamente.</p></div>`;
                }
            }

            function formatSupplierDate(dateValue) {
                if (!dateValue) return 'N/A';
                let date;
                if (typeof dateValue.toDate === 'function') {
                    date = dateValue.toDate();
                } else if (typeof dateValue === 'string') {
                    date = new Date(dateValue);
                } else if (dateValue instanceof Date) {
                    date = dateValue;
                } else {
                    return 'Data inválida';
                }
                if (isNaN(date.getTime())) {
                    return 'Data inválida';
                }
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };

            function formatDate(dateStr) {
                if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return 'N/A';
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            }

            function formatCnpj(value) {
                if (!value) return "";
                let cnpj = String(value).replace(/\D/g, '');
                cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
                cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
                cnpj = cnpj.replace(/(\d{4})(\d)/, '$1-$2');
                return cnpj.slice(0, 18);
            }

            function formatPhone(phone) {
                if (!phone || typeof phone !== 'string') return '';
                const cleaned = phone.replace(/\D/g, '');
                if (cleaned.length === 11) {
                    return `${cleaned.substring(0, 2)} ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
                }
                if (cleaned.length === 10) {
                    return `${cleaned.substring(0, 2)} ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
                }
                return phone;
            }

            function copyToClipboard(text) {
                if (!text) return;
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copiado para a área de transferência!', 'success');
                } catch (err) {
                    showToast('Falha ao copiar texto.', 'error');
                }
                document.body.removeChild(textarea);
            }

            document.body.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    copyToClipboard(copyBtn.dataset.text);
                }
            });

            function createStyledField(icon, label, value, showLabel = true) {
                const cleanValue = value || 'Não informado';
                const labelHtml = showLabel ? `<p class="font-medium text-gray-500">${label}</p>` : '';
                return `
                    <div class="flex items-start gap-3">
                        <ion-icon name="${icon}" class="text-lg text-gray-400 mt-0.5"></ion-icon>
                        <div class="flex-1">
                            ${labelHtml}
                            <p class="text-gray-800">${cleanValue}</p>
                        </div>
                        <button class="copy-btn" data-text="${cleanValue}" title="Copiar ${label}">
                            <ion-icon name="copy-outline" class="text-lg"></ion-icon>
                        </button>
                    </div>`;
            }

            function createCopyableField(label, value, showLabel = true) {
                const cleanValue = value || 'Não informado';
                const labelHtml = showLabel ? `<span class="font-medium text-gray-600">${label}:</span>` : '';
                return `
                    <div class="flex justify-between items-center">
                        <div>
                            ${labelHtml}
                            <span class="text-gray-800 ml-2">${cleanValue}</span>
                        </div>
                        <button class="copy-btn" data-text="${cleanValue}" title="Copiar ${label}">
                            <ion-icon name="copy-outline" class="text-lg"></ion-icon>
                        </button>
                    </div>`;
            }

            // Inicialização da parte principal da aplicação
            loadSettings();
            loadFilterSettings();
            renderTable();
        });

    </script>
</body>

</html>
